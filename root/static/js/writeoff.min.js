function DrawTimeline(t){var e=$(t).data("timeline"),a=$(t).width(),n=65,o=14,r=3*o;if(a){var i=d3.time.scale().domain([e[0].start,e[e.length-1].end]).range([0+r,a-r]);d3.select(t).selectAll("svg").remove();var s=d3.select(t).append("svg").attr("width",a).attr("height",n);s.append("line").attr("stroke","black").attr("x1",0).attr("y1",n/2).attr("x2",a).attr("y2",n/2),s.selectAll("circle.boundary.start").data(e.filter(function(t,a){return 0==a||t.start-e[a-1].end>6e5})).enter().append("circle").attr("title",function(t,e){return t.start.toUTCString()}).attr("cx",function(t,e){return i(t.start)}),s.selectAll("circle.boundary.end").data(e).enter().append("circle").attr("title",function(t,e){return t.end.toUTCString()}).attr("cx",function(t,e){return i(t.end)}),s.selectAll("circle").attr("cy",n/2).attr("r",5).attr("fill","grey").attr("stroke","black").attr("stroke-width",1),s.append("circle").attr("title",function(t,e){return now.toUTCString()}).attr("cx",i(now)).attr("cy",n/2).attr("r",4).attr("fill","red").attr("stroke","black").attr("stroke-width",1),s.selectAll("text.dates.start").data(e.filter(function(t,a){return 0==a||t.start-e[a-1].end>432e5})).enter().append("text").text(function(t,e){return t.start.getDate()+" "+t.start.getShortMonth()}).attr("title",function(t,e){return t.start.toUTCString()}).attr("x",function(t,e){return i(t.start)}),s.selectAll("text.dates.end").data(e).enter().append("text").text(function(t,e){return t.end.getDate()+" "+t.end.getShortMonth()}).attr("title",function(t,e){return t.end.toUTCString()}).attr("x",function(t,e){return i(t.end)}),s.selectAll("text").attr("text-anchor","middle").attr("y",n/2+1.5*o).attr("fill","black").attr("font-size",.9*o).attr("font-family","sans-serif"),s.selectAll("text.labels").data(e).enter().append("text").text(function(t,e){return t.name}).attr("text-anchor","middle").attr("x",function(t,e){return(i(t.end)+i(t.start))/2}).attr("y",n/2-.75*o).attr("fill","black").attr("font-size",o).attr("font-family","sans-serif")}}function replaceSelection(t,e){"selectionStart"in t?(t.focus(),t.value=t.value.substr(0,t.selectionStart)+e.text+t.value.substr(t.selectionEnd,t.value.length),t.selectionStart=e.start,t.selectionEnd=e.end):document.selection?(t.focus(),document.selection.createRange().text=e.text):t.value+=e.text}function pushReply(t){var e=$(".Post-submit textarea");if(e.size()){var a=e.getSelection();return a.text=">>"+t+"\n",a.end=a.start+=a.text.length,e.focus(),replaceSelection(e.get(0),a),1}return 0}function loadOrphan(t){return $.ajax({method:"GET",url:"/post/"+t+"/view",data:{event_id:event_id,entry_id:entry_id},success:function(e,a,n){e=$.parseHTML(e),postModifiers.apply(e),$orphans[t]=$(e).filter(".Post")}})}String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.collapse=function(){return this.replace(/\s+/g," ")},String.prototype.collate=function(){return this.toLowerCase().trim().collapse().replace(/[^\x20-\x7E]/g,"")},String.prototype.regex=function(){return this.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")},String.prototype.ucfirst=function(){return this.substring(0,1).toUpperCase()+this.substring(1,this.length)},Date.prototype.daysInMonth=function(){var t=this.getUTCMonth()+1;return 4==t||6==t||9==t||11==t?30:2==t?this.leapYear()?29:28:31},Date.deltaUnits=["year","month","day","hour","minute","second"],Date.deltaMethods=["FullYear","Month","Date","Hours","Minutes","Seconds"],Date.prototype._delta=function(t){var e=this,a={};return Date.deltaUnits.forEach(function(n,o){var r="getUTC"+Date.deltaMethods[o];a[n]=t[r]()-e[r]()}),a.second<0&&(a.minute--,a.second+=60),a.minute<0&&(a.hour--,a.minute+=60),a.hour<0&&(a.day--,a.hour+=24),a.day<0&&(a.month--,a.day+=e.daysInMonth()),a.month<0&&(a.year--,a.month+=12),a},Date.prototype.delta=function(t,e){var a=this,n=t||new Date,o=e||2;if(Math.abs(a.getTime()-n.getTime())<3e3)return"just now";var r=a._delta(n),i=[];Date.deltaUnits.forEach(function(t){if(o){var e=r[t];e&&i.push(e+" "+t+(1==e?"":"s")),i.length&&o--}});var s;return i.length<=2?s=i.join(" and "):(i[i.length-1]=", and "+i[i.length-1],s=i.join(", ")),n<a?"in "+s:s+" ago"},Date.prototype.leapYear=function(){var t=this.getUTCFullYear();return t%4==0&&t%100!=0||t%400==0},Date.prototype.getShortMonth=function(){return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][this.getMonth()]},Date.prototype.getDateSuffixed=function(){return this.getDate().ordinal()},Number.prototype.ordinal=function(){var t=this%100,e=this%10;return this+(0==e||e>=4||t>=11&&t<=13?"th":["st","nd","rd"][e-1])},Number.prototype.zeropad=function(t){for(var e=this+"";e.length<t;)e="0"+e;return e};var t0=new Date;$(document).ready(function(t){t('input[type="checkbox"].toggler').on("change",function(){var e=this;t(this).parent().find("input").each(function(){this.name!==e.name&&(this.disabled=!e.checked)}),"has_fic"==this.name&&t('input[name="wc_min"], input[name="wc_max"]').each(function(){this.disabled=!e.checked})}).trigger("change"),t("#preview img").each(function(){t(this).data("default",t(this).attr("src"))}),t('input[name="image"]').on("change",function(){var e=t("#preview img");if(this.files&&this.files[0]){var a=new FileReader;a.onload=function(t){e.attr("src",t.target.result)},a.readAsDataURL(this.files[0])}else e.attr("src",e.data("default"))})}),$(document).ready(function(){$(".Form.auto").each(function(){var t=$(this);t.find('input[type="submit"]').remove();var e=$.when();t.find("input, select, textarea").on("change",function(){var a=$(this);e.then($.ajax({type:t.attr("method"),url:t.attr("action"),data:a.serialize(),success:function(){a.removeClass("Form-error")},error:function(){a.addClass("Form-error")}}))})})}),$(document).ready(function(){$(".Breakdown").click(function(){for(var t=$(this),e=$(this).find("i"),a=$(this).closest("tr");a.next()&&a.next().hasClass("Breakdown-row");)a.next().remove();var n=e.hasClass("fa-plus");if(a.find(".Breakdown i").each(function(){$(this).removeClass("fa-minus"),$(this).addClass("fa-plus"),$(this).attr("title","Show breakdown")}),n){e.removeClass("fa-plus"),e.addClass("fa-minus"),e.attr("title","Hide breakdown");var o=a.clone().addClass("Breakdown-row"),r=$('<td colspan="99"/>');o.html(r),a.after(o),a.after('<tr class="Breakdown-row hidden"/>'),t.data("res")?r.html(t.data("res")):r.load(t.data("target"),function(e,a,n){"error"!=a?(r.find("h1").remove(),t.data("res",r.html())):r.html(n.statusTxt)})}}).each(function(){$(this).data("target",$(this).attr("href"))}).removeAttr("href")}),$(document).ready(function(){var t,e,a=$("#story-field"),n=$("#wordcount"),o=a.data("min"),r=a.data("max");a.bind("input change",function(a){t=this.value.trim(),e=t.length?t.split(/\s+/).length:0,n.val(e)}),a.bind("change",function(t){this.setCustomValidity(o>e?"Too few words":r<e?"Too many words":"")})}),$(document).ready(function(){$(".Event-timeline").each(function(){var t=timelines.shift();t.forEach(function(t){"start"in t&&(t.start=new Date(t.start+"Z")),t.end=new Date(t.end+"Z")}),$(this).removeClass("hidden"),$(this).data("timeline",t),DrawTimeline(this)}),$(window).on("resize",function(){$(".Event-timeline").each(function(){DrawTimeline(this)})})}),$(document).ready(function(){var t=$(".Event-header");t.each(function(){if(!this.dataset.nocollapse){var e=$(this),a=e.next();if(a&&a.hasClass("Event-details")){e.addClass("active");var n=0;if(t.size()>1&&8>t.size()){var o=432e5;a.find(".Event-timeline").data("timeline").forEach(function(t){t.start.getTime()-o<now.getTime()&&now.getTime()<t.end.getTime()+o&&(n=1)})}n?e.addClass("expanded"):a.addClass("hidden"),e.click(function(t){$(t.target).is("a")||$(t.target).closest("a").length||(e.toggleClass("expanded"),a.toggleClass("hidden"),a.hasClass("hidden")||DrawTimeline(a.find(".Event-timeline").get(0)))})}}})}),$(document).ready(function(){var t=$(".Ballot.cast");if(t.length){var e=$.when(),a=function(){var t=$(".Ballot .ordered .Ballot-item").length;$(".Ballot .ordered .Ballot-score").each(function(e){var a=100*(1-e/(t-1));this.innerHTML='<span title="'+a.toFixed(5)+'">'+Math.round(a)+"%</span>"})},n=function(){e.then($.ajax({method:"POST",url:document.location.pathname,data:$('.Ballot .ordered input[name="order"]').serialize()}))};Sortable.create($(".Ballot .ordered")[0],{group:{name:"ballot",pull:!1,put:!0},filter:".Ballot-directions",onSort:function(){a(),n()}}),Sortable.create($(".Ballot .unordered")[0],{group:{name:"ballot",pull:!0,put:!1},filter:".Ballot-append"});var o=function(){var t=$(this).closest(".Ballot-item"),e=t.prev();if(t.parent().hasClass("unordered"))t.detach(),$(".Ballot-directions").before(t);else{if(!e.length||!e.hasClass("Ballot-item"))return;t.detach(),e.before(t)}a(),n()},r=function(){var t=$(this).closest(".Ballot-item");e.then($.ajax({type:"POST",url:document.location.pathname,data:{action:"abstain",vote:t.find("input").attr("value")},success:function(e){t.find(".Ballot-score").text("N/A"),t.detach(),$(".Ballot .abstained").append(t),$(".Ballot .abstained").prev().removeClass("hidden"),a(),e<=0&&$(".Ballot-abstain").addClass("hidden")}}))},i=function(){var t=$(this).closest(".Ballot-item");e.then($.ajax({type:"POST",url:document.location.pathname,data:{action:"unabstain",vote:t.find("input").attr("value")},success:function(e){t.detach(),$(".Ballot-append").before(t),0==$(".Ballot .abstained .Ballot-item").length&&$(".Ballot .abstained").prev().addClass("hidden"),e>0&&$(".Ballot-abstain").removeClass("hidden")}}))};$(".Ballot-abstain").click(r),$(".Ballot-unabstain").click(i),$(".Ballot-up").click(o),$(".Ballot-append").click(function(){var t=$(this);t.hasClass("active")&&!t.hasClass("waiting")&&(t.addClass("waiting"),e.then($.ajax({type:"POST",url:document.location.pathname,data:{action:"append"},success:function(e,a,n){if("None left"==e)t.removeClass("active");else{var s=$(e.substring(e.indexOf("<tr"),e.indexOf("tr>")+3));s.find(".Ballot-abstain").click(r),s.find(".Ballot-unabstain").click(i),s.find(".Ballot-up").click(o),t.before(s)}},complete:function(e,a){t.removeClass("waiting")}})))})}});var postModifiers=[];postModifiers.apply=function(t){$(t).is(document)||(t=$("<div/>").append(t)),postModifiers.forEach(function(e){e(t)})},postModifiers.push(function(t){var e=$("time.delta",t).not(".Countdown time");if(e.size()){var a,n=function t(e){a=new Date;var n=now.getTime()+a.getTime()-t0.getTime()-50,o=new Date($(e).attr("datetime")).delta(new Date(n),1+!$(e).hasClass("short"));e.textContent=o,"just now"==o||/second/.test(o)||/minute/.test(o)&&!/and/.test(o)?setTimeout(t,5e3+5e3*Math.random(),e):/minute/.test(o)||/hour/.test(o)&&!/and/.test(o)?setTimeout(t,6e4+500*Math.random(),e):setTimeout(t,36e5+500*Math.random(),e)};e.each(function(){n(this)})}}),$(document).ready(function(){var t=$(".Countdown time"),e=$("time.date"),a=$("time.datetime");if(t.size()){var n,o=function(){n=new Date;var e=now.getTime()+n.getTime()-t0.getTime()-50;t.each(function(){var t=new Date($(this).attr("datetime")).getTime()-e;t<0&&(t=0);var a=t/1e3,n=a/60,o=n/60,r=o/24;a=Math.floor(a)%60,n=Math.floor(n)%60,o=Math.floor(o)%24,r=Math.floor(r),this.textContent=r+"d "+o.zeropad(2)+"h "+n.zeropad(2)+"m "+a.zeropad(2)+"s"})};setInterval(o,1e3),o()}e.each(function(){var t=new Date($(this).attr("datetime"));this.textContent=t.getDate()+" "+t.getShortMonth()+" "+t.getFullYear()}),a.each(function(){var t=new Date($(this).attr("datetime")),e=t.getTimezoneOffset();this.textContent=t.getDate()+" "+t.getShortMonth()+" "+t.getFullYear()+" "+t.getHours().zeropad(2)+":"+t.getMinutes().zeropad(2)+":"+t.getSeconds().zeropad(2)+" "+(e>0?"-":"+")+Math.floor(Math.abs(e)/60).zeropad(2)+(Math.abs(e)%60).zeropad(2)})}),$(document).ready(function(){$(".Results, .Scoreboard, .Prompts, .Ballot, .Artist-entries, .Storys.gallery").each(function(){$(this).find("thead").size()&&($(this).addClass("sortable"),new Tablesort(this))})}),$(document).ready(function(){$(".Storys-access").each(function(){var t=$(this);t.find(".Storys-access--update").remove();var e=$.when();t.find('input[type="checkbox"]').on("change",function(){e.then($.ajax({type:t.attr("method"),url:t.attr("action"),data:t.serialize()}))})})}),postModifiers.push(function(t){var e=$.when();$(".Prompts-vote--button, .Post-vote--button",t).on("click",function(t){t.preventDefault();var a=$(this),n=a.closest("form");e=e.then($.ajax({type:"POST",url:n.attr("action"),data:n.serializeArray().concat({name:a.attr("name"),value:a.attr("value")}),success:function(t,e,a){n.attr("data-vote",t.vote),"score"in t&&n.siblings().text(t.score||"")},error:function(t,e,a){alert("Vote failed: "+a)}}))})}),$(document).ready(function(){var t=$.when(),e=$(".Artist-swap");e.on("click",function(a){a.preventDefault();var n=$(this),o=n.closest("form");t=t.then($.ajax({type:"POST",url:o.attr("action"),data:o.serializeArray(),success:function(t,a,o){t=$.parseJSON(t),e.removeClass("active"),n.addClass("active"),$(".Artist-swap--selected").text(t.name).closest("a").attr("href",n.closest("li").find("a").attr("href")),$(".Post-submit").each(function(){var e=$(this).closest(".Post");e.find(".Post-author--name").text(t.name),e.find(".Post-author--avatar img").attr("src",t.avatar)})}}))})}),$(document).ready(function(){var t=localStorage.getItem("reply");t&&pushReply(t)&&localStorage.removeItem("reply")}),postModifiers.push(function(t){$(".Post-control--reply",t).each(function(){$(this).data("redirect",$(this).attr("href"))}).removeAttr("href").click(function(){var t=$(this),e=t.attr("data-target");t.data("redirect")?(localStorage.setItem("reply",e),document.location=t.data("redirect")):pushReply(e)})}),postModifiers.push(function(t){$(".Post-control--edit",t).removeAttr("href").click(function(){$(this).closest(".Post").addClass("edit")}),$(".Post-edit--cancel",t).click(function(){$(this).closest(".Post").removeClass("edit")});var e=$.when();$(".Post-edit--save",t).click(function(){var t=$(this),a=t.closest("form"),n=a.closest(".Post");e.then($.ajax({method:"POST",url:a.attr("action"),data:a.serializeArray(),success:function(t,e,a){t=$.parseHTML(t),postModifiers.apply(t),n.find(".Post-contents--body").empty().append(t)},error:function(t,e,a){alert("Error: "+a)},complete:function(){n.removeClass("edit")}}))})}),postModifiers.push(function(t){var e=[[".fa-bold","b",!1,66],[".fa-italic","i",!1,73],[".fa-underline","u",!1,85],[".fa-strikethrough","s",!1,83],[".fa-link","url",!0],[".fa-text-height","size",!0],[".fa-font","color",!0],[".fa-quote-right","quote",!1,81],[".fa-align-center","center",!1],[".fa-align-right","right",!1]],a=$(".Post-form--controls",t);e.forEach(function(e){var n=e[0],o=e[1],r=e[2],i=e[3],s=function(t){var e=t.getSelection();r?(e.text="["+o+'=""]'+e.text+"[/"+o+"]",e.end=e.start+=3+o.length):(e.text="["+o+"]"+e.text+"[/"+o+"]",e.start+=2+o.length,e.end+=2+o.length),t.focus(),replaceSelection(t.get(0),e)};a.find(n).click(function(){s($(this).closest("form").find("textarea"))}),"undefined"!=typeof i&&$(".Post-form--body textarea",t).on("keydown",function(t){t.ctrlKey&&t.which==i&&(t.preventDefault(),s($(this)))})})});var $orphans=[];$(document).ready(function(){var t=$(".Pager"),e=function(e){return t.addClass("loading"),$.ajax({url:document.location.pathname,data:{page:e},method:"GET",success:function(a,n,o){a=$.parseHTML(a),postModifiers.apply(a),$(".Posts").empty().append($(a).find(".Post")),$(".Pager a").removeClass("current").each(function(){var t=$(this);t.text()==e&&t.addClass("current")}),t.removeClass("loading")}})};t.size()&&t.find("a").removeAttr("href").click(function(){var a=$(this);if(!t.hasClass("loading")){var n=a.hasClass("current");e(a.text()).then(function(){!n&&a.closest(".Pager").hasClass("bottom")&&$("html, body").scrollTop($(".Pager.top").offset().top)})}});var a=function(){if($(".Post.highlight").removeClass("highlight"),document.location.hash.search(/^#[0-9]+$/)!=-1){var t=$(".Posts .Post"+document.location.hash),a=document.location.hash.substr(1),n=$.when(),o=function(){t.addClass("highlight"),$("html, body").scrollTop(t.offset().top)};t.size()?o():($orphans[a]||(n=loadOrphan(a)),n.then(function(){var n=$orphans[a];n.size()&&("0"!=n.attr("data-page")?e(n.attr("data-page")).then(function(){t=$(".Post"+document.location.hash),o()}):window.location="/post/"+n.attr("id"))}))}};$(window).on("hashchange",a).trigger("hashchange")}),postModifiers.push(function(t){var e=$.when();$(".Post-reply",t).on("mouseenter",function(){var t=$(this),a=t.closest(".Post"),n=t.attr("data-target"),o=$(".Post#"+n),r=$('<div class="Post-hover"/>');o.size()?o=o.clone().removeClass("hidden"):$orphans[n]?o=$orphans[n].clone():(t.addClass("loading"),e=loadOrphan(n).then(function(){t.removeClass("loading"),o=$orphans[n].clone()})),e=e.then(function(){o.removeAttr("id"),r.css({top:t.offset().top+1.2*t.outerHeight(),left:a.offset().left-$("body").css("font-size").replace(/px/,"")}),t.is(":hover")&&(r.append(o),$("body").append(r))})}).on("mouseleave",function(){$(".Post-hover").remove()}).removeAttr("href").on("click",function(){document.location.hash=$(this).attr("data-target")})}),$(document).ready(function(){$('input[name="avatar"]').on("change",function(){var t=$(".Artist-avatar img");if(t.data("default")||t.data("default",t.attr("src")),this.files&&this.files[0]){var e=new FileReader;e.onload=function(e){t.attr("src",e.target.result)},e.readAsDataURL(this.files[0])}else t.attr("src",t.data("default"))})}),$(document).ready(function(){var t=$(".Font-select"),e=$(".Story-example");e.removeClass("hidden"),t.on("change",function(){e.css("font-family",t.find(":selected").val())}).trigger("change")}),$(document).ready(function(){postModifiers.apply(document)});
//# sourceMappingURL=/static/js/writeoff.min.js.map